pipeline {
    agent any

    environment {
        USER = 'ec2-user'  
        BASTION_IP = credentials('bastion-ip')  
        PRIVATE_IP1 = credentials('private-ip1') 
        PRIVATE_IP2 = credentials('private-ip2')  
    }

    stages {
        stage('deploying') {
            steps {
                sh 'echo we are ready to deploy ....'
            }
        }

        stage('connect to servers') {
            parallel {
                stage('deploy to first-instance') {
                    steps {
                        withCredentials([
                            file(credentialsId: 'private-key-1', variable: 'PRIVATE_KEY_1'),
                            file(credentialsId: 'private-key-2', variable: 'PRIVATE_KEY_2')   
                        ]) {
                            sh '''
                                eval $(ssh-agent -s)
                                ssh-add ${PRIVATE_KEY_1}
                                ssh -o StrictHostKeyChecking=no ${USER}@${BASTION_IP} 
                                echo Connexion au bastion réussie !
                                ssh-add ${PRIVATE_KEY_2}
                                ssh -o StrictHostKeyChecking=no -J ${USER}@${BASTION_IP} ${USER}@${PRIVATE_IP1} \
                                    "echo ✅ Déploiement sur la première instance privée réussi ! && hostname"
                            '''
                        }
                    }
                }

                stage('deploy to second-instance') {
                    steps {
                        withCredentials([
                            file(credentialsId: 'private-key-1', variable: 'PRIVATE_KEY_1'),
                            file(credentialsId: 'private-key-2', variable: 'PRIVATE_KEY_2')   
                        ]) {
                            sh '''
                                eval $(ssh-agent -s)
                                ssh-add ${PRIVATE_KEY_1}                            
                                ssh -o StrictHostKeyChecking=no ${USER}@${BASTION_IP}
                                echo Connexion au bastion réussie !                     
                                ssh-add ${PRIVATE_KEY_2}
                                ssh -o StrictHostKeyChecking=no -J ${USER}@${BASTION_IP} ${USER}@${PRIVATE_IP2} \
                                    "echo ✅ Déploiement sur la deuxième instance privée réussi ! && hostname"
                            '''
                        }
                    }
                }
            }
        }
    }
    post {
        success {
            echo 'the pipeline is successful.'
        }
        failure {
            echo 'the pipeline fails.'
        }
    }
}